{% extends "base.html" %}

{% block content %}
<section class="hero">
  <div>
    <h1>订阅续费提醒</h1>
    <p>统一管理你的服务续费周期、金额和提醒配置。</p>
  </div>
  <a href="{{ url_for('create_subscription') }}" class="btn primary">新增订阅</a>
</section>

<section class="stats">
  <div class="stat-card">
    <div class="stat-label">当前订阅</div>
    <div class="stat-value">{{ stats.count }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">即将到期</div>
    <div class="stat-value">{{ stats.due_soon }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">总金额 (CNY)</div>
    <div class="stat-value">¥{{ "%.2f"|format(stats.total_cny) }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">月均成本 (CNY)</div>
    <div class="stat-value">¥{{ "%.2f"|format(stats.monthly_cny) }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">30天内应付</div>
    <div class="stat-value">¥{{ "%.2f"|format(stats.upcoming_30_cny) }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">年度预算 (CNY)</div>
    <div class="stat-value">¥{{ "%.2f"|format(stats.yearly_cny) }}</div>
  </div>
</section>

<div class="view-root view-{{ view }}">
<section class="filters">
  <form method="get" class="filter-bar">
    <input type="hidden" name="view" value="{{ view }}">
    <input type="search" name="q" placeholder="搜索服务或分类" value="{{ search }}">
    <select name="category">
      <option value="all">全部分类</option>
      {% for category in categories %}
        <option value="{{ category }}" {% if current_category == category %}selected{% endif %}>{{ category }}</option>
      {% endfor %}
    </select>
    <select name="status">
      <option value="all" {% if status_filter == 'all' %}selected{% endif %}>全部状态</option>
      <option value="soon" {% if status_filter == 'soon' %}selected{% endif %}>即将到期</option>
      <option value="active" {% if status_filter == 'active' %}selected{% endif %}>进行中</option>
      <option value="paused" {% if status_filter == 'paused' %}selected{% endif %}>已暂停</option>
    </select>
    <select name="sort">
      <option value="due" {% if sort == 'due' %}selected{% endif %}>到期日</option>
      <option value="remaining" {% if sort == 'remaining' %}selected{% endif %}>剩余天数</option>
      <option value="amount" {% if sort == 'amount' %}selected{% endif %}>金额 (CNY)</option>
      <option value="monthly" {% if sort == 'monthly' %}selected{% endif %}>月均成本</option>
      <option value="yearly" {% if sort == 'yearly' %}selected{% endif %}>年度预算</option>
      <option value="name" {% if sort == 'name' %}selected{% endif %}>名称</option>
    </select>
    <button class="btn" type="submit">筛选</button>
  </form>
</section>

<section class="view-toggle" data-view-toggle>
  <button type="button" class="btn ghost {% if view == 'card' %}active{% endif %}" data-view="card">卡片</button>
  <button type="button" class="btn ghost {% if view == 'compact' %}active{% endif %}" data-view="compact">紧凑</button>
  <button type="button" class="btn ghost {% if view == 'table' %}active{% endif %}" data-view="table">表格</button>
</section>

<section class="insights">
  <article class="panel">
    <div class="panel-header">
      <h2>30天内到期</h2>
      <span class="muted">前 5 条</span>
    </div>
    <div class="list">
      {% for item in upcoming %}
        <div class="list-item">
          <div>
            <div class="list-title">{{ item.name }}</div>
            <div class="list-meta">{{ item.due_date.strftime('%Y-%m-%d') }} · {{ item.category }}</div>
          </div>
          <div class="list-value">
            <div>¥{{ "%.2f"|format(item.amount_cny) if item.amount_cny is not none else "--" }}</div>
            <div class="mini">剩 {{ item.remaining_days }} 天</div>
          </div>
        </div>
      {% else %}
        <div class="empty">30 天内暂无到期订阅</div>
      {% endfor %}
    </div>
  </article>
  <article class="panel">
    <div class="panel-header">
      <h2>分类预算（月均）</h2>
      <span class="muted">Top 5</span>
    </div>
    {% for item in category_breakdown %}
      <div class="bar-item">
        <div class="bar-label">
          <span>{{ item.category }}</span>
          <span>¥{{ "%.2f"|format(item.monthly_cny) }}</span>
        </div>
        <div class="bar-track">
          <div class="bar-fill" style="width: {{ "%.0f"|format(item.percent) }}%"></div>
        </div>
      </div>
    {% else %}
      <div class="empty">暂无分类预算数据</div>
    {% endfor %}
  </article>
</section>

<section class="cards view-card-only">
  {% for sub in subscriptions %}
    <article class="card {% if sub.due_soon %}due-soon{% endif %} {% if not sub.enabled %}paused{% endif %}" style="--i: {{ loop.index }}">
      <div class="card-header">
        <div>
          <h3>{{ sub.name }}</h3>
          <div class="meta">{{ sub.category }} · {{ cycle_labels[sub.billing_cycle] }}</div>
        </div>
        <div class="badge">剩余 {{ sub.remaining_days }} 天</div>
      </div>
      <div class="card-body">
        <div class="row">
          <div>
            <div class="label">到期日</div>
            <div class="value">{{ sub.due_date.strftime('%Y-%m-%d') }}</div>
            {% if sub.rolled %}
              <div class="mini">已自动顺延</div>
            {% endif %}
          </div>
          <div>
            <div class="label">金额</div>
            <div class="value">{{ "%.2f"|format(sub.amount) }} {{ sub.currency }}</div>
            <div class="mini">
              折合 ¥{{ "%.2f"|format(sub.amount_cny) if sub.amount_cny is not none else "--" }}
              {% if sub.monthly_equiv_cny is not none %}
                · 月均 ¥{{ "%.2f"|format(sub.monthly_equiv_cny) }}
              {% endif %}
            </div>
          </div>
          <div>
            <div class="label">剩余价值</div>
            <div class="value">¥{{ "%.2f"|format(sub.remaining_value) if sub.remaining_value is not none else "--" }}</div>
            <div class="mini">提醒：提前 {{ sub.reminder_days }} 天</div>
          </div>
        </div>
        <div class="progress">
          <div class="progress-bar" style="width: {{ "%.0f"|format(sub.progress_pct) }}%"></div>
        </div>
        <div class="mini">周期进度 {{ "%.0f"|format(sub.progress_pct) }}%</div>
        {% if sub.notes %}
          <div class="notes">{{ sub.notes }}</div>
        {% endif %}
      </div>
      <div class="card-footer">
        <div class="links">
          {% if sub.renew_url %}
            <a href="{{ sub.renew_url }}" target="_blank" class="btn ghost">续费地址</a>
            <button type="button" class="btn ghost" data-copy="{{ sub.renew_url }}">复制链接</button>
          {% else %}
            <span class="muted">未填写续费地址</span>
          {% endif %}
        </div>
        <div class="actions">
          <form method="post" action="{{ url_for('toggle_subscription', sub_id=sub.id) }}">
            <button type="submit" class="btn ghost">{{ "暂停" if sub.enabled else "启用" }}</button>
          </form>
          <form method="post" action="{{ url_for('renew_subscription', sub_id=sub.id) }}">
            <button type="submit" class="btn ghost" data-confirm="确认已续费并顺延 {{ sub.name }}？">已续费</button>
          </form>
          <a href="{{ url_for('edit_subscription', sub_id=sub.id) }}" class="btn">编辑</a>
          <form method="post" action="{{ url_for('delete_subscription', sub_id=sub.id) }}">
            <button type="submit" class="btn danger" data-confirm="确认删除 {{ sub.name }} ？">删除</button>
          </form>
        </div>
      </div>
    </article>
  {% else %}
    <div class="empty">还没有订阅，点击“新增订阅”开始。</div>
  {% endfor %}
</section>

<section class="compact-list view-compact-only">
  {% for sub in subscriptions %}
    <div class="compact-row {% if sub.due_soon %}due-soon{% endif %} {% if not sub.enabled %}paused{% endif %}">
      <div class="compact-main">
        <div class="compact-title">{{ sub.name }}</div>
        <div class="compact-meta">{{ sub.category }} · {{ cycle_labels[sub.billing_cycle] }} · 到期 {{ sub.due_date.strftime('%Y-%m-%d') }}</div>
      </div>
      <div class="compact-right">
        <div class="compact-amount">{{ "%.2f"|format(sub.amount) }} {{ sub.currency }}</div>
        <div class="mini">剩 {{ sub.remaining_days }} 天 · ¥{{ "%.2f"|format(sub.remaining_value) if sub.remaining_value is not none else "--" }}</div>
      </div>
      <div class="compact-actions">
        <form method="post" action="{{ url_for('toggle_subscription', sub_id=sub.id) }}">
          <button type="submit" class="btn small ghost">{{ "暂停" if sub.enabled else "启用" }}</button>
        </form>
        <form method="post" action="{{ url_for('renew_subscription', sub_id=sub.id) }}">
          <button type="submit" class="btn small ghost" data-confirm="确认已续费并顺延 {{ sub.name }}？">已续费</button>
        </form>
        <a href="{{ url_for('edit_subscription', sub_id=sub.id) }}" class="btn small">编辑</a>
      </div>
    </div>
  {% else %}
    <div class="empty">还没有订阅，点击“新增订阅”开始。</div>
  {% endfor %}
</section>

<section class="table-view view-table-only">
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>服务</th>
          <th>分类</th>
          <th>周期</th>
          <th>到期日</th>
          <th>剩余</th>
          <th>金额</th>
          <th>折合</th>
          <th>剩余价值</th>
          <th>状态</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        {% for sub in subscriptions %}
          <tr class="{% if sub.due_soon %}due-soon{% endif %} {% if not sub.enabled %}paused{% endif %}">
            <td>{{ sub.name }}</td>
            <td>{{ sub.category }}</td>
            <td>{{ cycle_labels[sub.billing_cycle] }}</td>
            <td>{{ sub.due_date.strftime('%Y-%m-%d') }}</td>
            <td>{{ sub.remaining_days }} 天</td>
            <td>{{ "%.2f"|format(sub.amount) }} {{ sub.currency }}</td>
            <td>¥{{ "%.2f"|format(sub.amount_cny) if sub.amount_cny is not none else "--" }}</td>
            <td>¥{{ "%.2f"|format(sub.remaining_value) if sub.remaining_value is not none else "--" }}</td>
            <td>{{ "启用" if sub.enabled else "暂停" }}</td>
            <td class="table-actions">
              <form method="post" action="{{ url_for('toggle_subscription', sub_id=sub.id) }}">
                <button type="submit" class="btn small ghost">{{ "暂停" if sub.enabled else "启用" }}</button>
              </form>
              <form method="post" action="{{ url_for('renew_subscription', sub_id=sub.id) }}">
                <button type="submit" class="btn small ghost" data-confirm="确认已续费并顺延 {{ sub.name }}？">已续费</button>
              </form>
              <a href="{{ url_for('edit_subscription', sub_id=sub.id) }}" class="btn small">编辑</a>
              <form method="post" action="{{ url_for('delete_subscription', sub_id=sub.id) }}">
                <button type="submit" class="btn small danger" data-confirm="确认删除 {{ sub.name }} ？">删除</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="10" class="empty">还没有订阅，点击“新增订阅”开始。</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
</div>
{% endblock %}

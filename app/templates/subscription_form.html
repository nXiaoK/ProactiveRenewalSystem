{% extends "base.html" %}

{% block content %}
<section class="hero">
  <div>
    <h1>{{ "新增订阅" if subscription is none else "编辑订阅" }}</h1>
    <p>完善续费金额、周期与提醒配置。</p>
  </div>
</section>

<form method="post" class="form card-form">
  <div class="grid">
    <label>
      服务名称
      <input type="text" name="name" required value="{{ subscription['name'] if subscription else '' }}">
    </label>
    <label>
      分类
      {% set current_category = subscription['category'] if subscription else '' %}
      {% set category_in_list = current_category in categories %}
      {% set show_custom_category = (not categories) or (current_category and not category_in_list) %}
      <div class="field-stack">
        <select data-select="category">
          <option value="" {% if not current_category %}selected{% endif %}>选择已有分类</option>
          {% if not categories %}
            <option value="" disabled>暂无已有分类</option>
          {% endif %}
          {% for category in categories %}
            <option value="{{ category }}" {% if current_category == category %}selected{% endif %}>{{ category }}</option>
          {% endfor %}
          <option value="__custom__" {% if show_custom_category %}selected{% endif %}>手动输入...</option>
        </select>
        <input type="text" name="category" data-input="category" placeholder="如：工作 / 影音" value="{{ current_category }}" {% if not show_custom_category %}hidden{% endif %}>
      </div>
      <div class="mini">可直接输入新分类</div>
    </label>
    <label>
      类型
      {% set current_flow = subscription['flow'] if subscription else 'expense' %}
      <select name="flow">
        <option value="expense" {% if current_flow == 'expense' %}selected{% endif %}>支出</option>
        <option value="income" {% if current_flow == 'income' %}selected{% endif %}>收益</option>
      </select>
    </label>
    <label>
      续费金额
      <input type="number" step="0.01" name="amount" required value="{{ subscription['amount'] if subscription else '' }}">
    </label>
    <label>
      货币
      {% set current_currency = subscription['currency'] if subscription else 'CNY' %}
      {% set currency_in_list = current_currency in currencies %}
      {% set show_custom_currency = current_currency and not currency_in_list %}
      <div class="field-stack">
        <select data-select="currency">
          {% for currency in currencies %}
            <option value="{{ currency }}" {% if current_currency == currency %}selected{% endif %}>{{ currency }}</option>
          {% endfor %}
          <option value="__custom__" {% if show_custom_currency %}selected{% endif %}>手动输入...</option>
        </select>
        <input name="currency" data-input="currency" value="{{ current_currency }}" placeholder="CNY" {% if not show_custom_currency %}hidden{% endif %}>
      </div>
      <div class="mini">选择常用币种或手动输入</div>
    </label>
    <label>
      续费类型
      <select name="billing_cycle">
        {% set current_cycle = subscription['billing_cycle'] if subscription else 'month' %}
        {% for cycle in cycle_options %}
          <option value="{{ cycle }}" {% if current_cycle == cycle %}selected{% endif %}>{{ cycle_labels[cycle] }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      到期日期
      <input type="date" name="due_date" required value="{{ subscription['due_date'] if subscription else '' }}">
    </label>
    <label>
      续费地址
      <input type="url" name="renew_url" placeholder="https://" value="{{ subscription['renew_url'] if subscription else '' }}">
    </label>
    <label>
      提醒提前天数
      <input type="number" name="reminder_days" value="{{ subscription['reminder_days'] if subscription else default_reminder_days }}">
    </label>
  </div>

  <label>
    备注
    <textarea name="notes" rows="3">{{ subscription['notes'] if subscription else '' }}</textarea>
  </label>

  <label class="checkbox">
    <input type="checkbox" name="enabled" {% if subscription is none or subscription['enabled'] %}checked{% endif %}>
    启用提醒
  </label>

  <div class="form-actions">
    <button type="submit" class="btn primary">保存</button>
    <a href="{{ url_for('index') }}" class="btn ghost">取消</a>
  </div>
</form>
{% endblock %}
